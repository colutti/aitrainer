
import pytest
from unittest.mock import MagicMock
from datetime import datetime
from src.services.history_compactor import HistoryCompactor

# Mock generic message object
class MockMessage:
    def __init__(self, text, sender, timestamp):
        self.text = text
        self.sender = sender
        self.timestamp = timestamp

def generate_history(count=100):
    msgs = []
    for i in range(count):
        msgs.append(
            MockMessage(
                text=f"This is message number {i}",
                sender="student" if i % 2 == 0 else "trainer",
                timestamp=datetime.now().isoformat()
            )
        )
    return msgs

@pytest.fixture
def compactor_service():
    mock_db = MagicMock()
    mock_llm = MagicMock()
    
    # Setup profile
    mock_profile = MagicMock()
    mock_profile.last_compaction_timestamp = None
    mock_profile.long_term_summary = "Old summary"
    mock_db.get_user_profile.return_value = mock_profile
    
    mock_db.update_user_profile_fields.return_value = True
    
    # Setup LLM stream
    # stream_simple returns an async generator
    async def mock_stream(*args, **kwargs):
        yield "New summary content generated by LLM"
    
    mock_llm.stream_simple.side_effect = mock_stream
    
    service = HistoryCompactor(mock_db, mock_llm)
    return service, mock_db

# Removed @pytest.mark.asyncio to avoid loop conflict
def test_benchmark_compact_history(benchmark, compactor_service):
    service, mock_db = compactor_service
    
    # Mock history return (100 messages)
    msgs = generate_history(100)
    mock_db.get_chat_history.return_value = msgs
    
    # Benchmark sync wrapper
    def run_sync():
        service.compact_history("bench@test.com", active_window_size=20)
    
    benchmark(run_sync)

