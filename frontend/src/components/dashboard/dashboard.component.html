<div data-test="main-grid" class="h-full overflow-y-auto p-6 bg-dark-bg text-text-primary">
  <h1 class="text-3xl font-bold mb-6 tracking-tight">Dashboard</h1>
  
  <div *ngIf="isLoading()" class="flex justify-center items-center h-64">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
  </div>

  <div class="space-y-8 p-1">
    
    <!-- ==================== CORPO SECTION ==================== -->

    <ng-container *ngIf="!isLoading()">
        <app-section-header
            data-test="section-composition"
            title="Composição Corporal"
            subtitle="Peso, gordura e massa muscular">
        </app-section-header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Row 1 -->
            <app-widget-line-chart 
                class="lg:col-span-2"
                title="Tendência de Peso" 
                subtitle="Peso suavizado (Histórico)"
                footerLabel="Variação Total"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate"
                [chartData]="weightChartData"
                [options]="weightChartOptions">
                <div slot="header-action" class="flex items-center gap-2">
                    <span *ngIf="metabolismStats()?.expenditure_trend === 'up'" class="text-[8px] text-green-400 font-bold uppercase tracking-tighter">↑ METABOLISMO</span>
                    <span *ngIf="metabolismStats()?.expenditure_trend === 'down'" class="text-[8px] text-red-400 font-bold uppercase tracking-tighter">↓ METABOLISMO</span>
                    <!-- MOVED TO BODY TAB: metabolism confidence -->
                    <!-- <span class="text-[8px] text-primary bg-primary/10 px-2 py-0.5 rounded border border-primary/20 font-bold uppercase tracking-tighter">{{ metabolismStats()?.confidence || 'Calculado' }}</span> -->
                </div>
                <div slot="footer-value" class="text-sm font-bold" [ngClass]="getWeightVariation() < 0 ? 'text-green-400' : 'text-red-400'">
                    {{ getWeightVariation() > 0 ? '+' : '' }}{{ getWeightVariation() | appNumberFormat:'weight' }} kg
                </div>
            </app-widget-line-chart>

            <app-widget-tdee-summary
                class="lg:col-span-2"
                title="Seu Gasto Energético"
                [tdee]="metabolismStats()?.tdee || 0"
                [targetCalories]="metabolismStats()?.daily_target || 0"
                [goalType]="metabolismStats()?.goal_type">
            </app-widget-tdee-summary>

            <!-- Row 2 -->
            <app-widget-body-evolution 
                class="lg:col-span-2"
                [fatChange]="metabolismStats()?.fat_change_kg" 
                [muscleChange]="metabolismStats()?.muscle_change_kg || 0"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate">
            </app-widget-body-evolution>

            <app-widget-metabolic-gauge 
                class="lg:col-span-2"
                [status]="metabolismStats()?.status || 'maintenance'" 
                [energyBalance]="metabolismStats()?.energy_balance || 0">
            </app-widget-metabolic-gauge>

            <!-- Row 3 -->
            <app-widget-line-chart 
                class="lg:col-span-2"
                title="Massa Gorda (%)" 
                subtitle="TENDÊNCIA DE PERCENTUAL"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate"
                [chartData]="fatTrendChartData"
                [options]="compositionChartOptions">
            </app-widget-line-chart>

            <app-widget-line-chart 
                class="lg:col-span-2"
                title="Massa Magra (%)" 
                subtitle="TENDÊNCIA DE PERCENTUAL"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate"
                [chartData]="muscleTrendChartData"
                [options]="compositionChartOptions">
            </app-widget-line-chart>
        </div>
    </ng-container>

    <!-- Shared loading template for widgets -->
    <ng-template #loadingMini>
       <div class="space-y-4 animate-pulse">
          <div class="h-8 bg-secondary/20 rounded w-1/2"></div>
          <div class="h-12 bg-secondary/10 rounded w-full"></div>
          <div class="h-4 bg-secondary/20 rounded w-3/4"></div>
       </div>
    </ng-template>

    <!-- ==================== NUTRIÇÃO SECTION ==================== -->
    <ng-container *ngIf="nutritionStats() as n">
        <app-section-header
            data-test="section-nutrition"
            title="Alimentação"
            subtitle="Calorias, macros e aderência à dieta">
        </app-section-header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 w-full">
            <!-- Row 1: Correlation & History Side-by-Side -->
            <!-- MOVED TO BODY TAB: calories-weight-comparison -->
            <!-- <app-widget-calories-weight-comparison
                class="lg:col-span-2"
                title="Análise de Correlação: Calorias vs Peso"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate"
                [weightTrend]="metabolismStats()?.weight_trend || []"
                [calorieHistory]="n.last_14_days || []">
            </app-widget-calories-weight-comparison> -->

            <app-widget-line-chart 
                class="lg:col-span-2"
                title="Trend de Ingestão de Calorias (14 dias)" 
                subtitle="KCAL / DIA"
                [startDate]="nutritionStats()?.startDate"
                [endDate]="nutritionStats()?.endDate"
                [chartData]="lineChartData"
                [options]="lineChartOptions">
            </app-widget-line-chart>

            <!-- Row 2: Macros & Targets -->
            <app-widget-macro-targets
                class="lg:col-span-2"
                title="Performance de Macros (7 dias)"
                [avgProtein]="n.avg_protein || 0"
                [targetProtein]="n.macro_targets.protein"
                [avgCarbs]="( (n.avg_daily_calories || 0) * 0.4 / 4)"
                [targetCarbs]="n.macro_targets.carbs"
                [avgFat]="( (n.avg_daily_calories || 0) * 0.3 / 9)"
                [targetFat]="n.macro_targets.fat"
                [stabilityScore]="n.stability_score"
                [startDate]="n.startDate"
                [endDate]="n.endDate">
            </app-widget-macro-targets>

            <app-widget-macros-today 
                class="lg:col-span-2"
                [calories]="n.today?.calories || 0" 
                [protein]="n.today?.protein_grams || 0" 
                [carbs]="n.today?.carbs_grams || 0" 
                [fat]="n.today?.fat_grams || 0">
            </app-widget-macros-today>

            <!-- MOVED TO BODY TAB: average-calories -->
            <!-- <app-widget-average-calories 
                class="lg:col-span-2" 
                [avg7Days]="n.avg_daily_calories" 
                [avg14Days]="n.avg_daily_calories_14_days">
            </app-widget-average-calories> -->
</div>
    </ng-container>

    <!-- ==================== TREINOS SECTION ==================== -->
    <ng-container *ngIf="!isLoading() && stats() as s">
        <app-section-header
            data-test="section-performance"
            title="Desempenho"
            subtitle="Volume, PRs e frequência">
        </app-section-header>

        <!-- Grid 1: Performance Summary -->
        <!-- Main Data Grid -->
        <!-- Main Data Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Training Performance -->
            <app-widget-recent-prs class="lg:col-span-2" [prs]="s.recent_prs"></app-widget-recent-prs>

            <app-widget-last-activity [lastWorkout]="s.last_workout"></app-widget-last-activity>

            <app-widget-strength-radar [strengthRadar]="s.strength_radar"></app-widget-strength-radar>

            <app-widget-weekly-distribution [volumeStats]="s.volume_by_category || []"></app-widget-weekly-distribution>

            <!-- Volume Trend (Wide) -->
            <app-widget-line-chart 
                class="lg:col-span-4"
                title="Evolução de Volume Total de Carga (8 semanas)" 
                subtitle="CARGA ACUMULADA (KG POR SEMANA)"
                [chartData]="volumeTrendChartData"
                [options]="volumeTrendChartOptions">
            </app-widget-line-chart>
        </div>
    </ng-container>

        <!-- ==================== ESTATÍSTICAS E CONSISTÊNCIA ==================== -->
        <app-section-header
            data-test="section-quality"
            title="Qualidade dos Dados"
            subtitle="Confiabilidade das suas métricas">
        </app-section-header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 w-full col-span-full">
            <!-- Training Stats Group -->
            @if (stats(); as s) {
                <app-widget-streak title="Sequência de Treinos" [streakWeeks]="s.current_streak_weeks"></app-widget-streak>
                <app-widget-frequency title="Treinos Esta Semana" [weeklyFrequency]="s.weekly_frequency"></app-widget-frequency>
            }

            <!-- Nutrition Stats Group -->
            @if (nutritionStats(); as n) {
                <app-widget-adherence title="Meta Calórica Atingida" [weeklyAdherence]="n.weekly_adherence"></app-widget-adherence>

                <!-- MOVED TO BODY TAB: calorie-volatility -->
                <!-- <app-widget-calorie-volatility [variance]="120"></app-widget-calorie-volatility> -->
            }

            <!-- Weight Log Stats (Wide) -->
            <!-- MOVED TO BODY TAB: weight-histogram -->
            <!-- <app-widget-weight-histogram
                class="lg:col-span-2"
                [consistency]="metabolismStats()?.consistency || []">
            </app-widget-weight-histogram> -->

            <!-- Global Confidence Info -->
            <!-- MOVED TO BODY TAB: data-quality -->
            <!-- <app-widget-data-quality
                class="lg:col-span-2"
                [consistencyScore]="metabolismStats()?.consistency_score || 0"
                [weightLogsCount]="metabolismStats()?.weight_logs_count || 0">
            </app-widget-data-quality> -->
        </div>

</div>
