<div class="h-full overflow-y-auto p-6 bg-dark-bg text-text-primary">
  <h1 class="text-3xl font-bold mb-6 tracking-tight">Dashboard</h1>
  
  <div *ngIf="isLoading()" class="flex justify-center items-center h-64">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
  </div>

  <div class="space-y-8 p-1">
    
    <!-- AI Insight (HERO) -->
    <div class="mb-4" *ngIf="metabolismStats()?.confidence !== 'none'">
      <div
        class="bg-light-bg rounded-2xl border border-primary/30 p-[1px] shadow-2xl relative overflow-hidden group"
      >
        <!-- Animated shine effect -->
        <div
          class="absolute inset-0 bg-gradient-to-r from-transparent via-primary/10 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000 ease-out pointer-events-none z-10"
        ></div>

        <div
          class="bg-dark-bg/50 backdrop-blur-sm rounded-2xl p-7 md:p-10 flex flex-col md:flex-row gap-10 md:gap-12 relative z-0 h-full"
        >
          <!-- Trainer Avatar & Pulse -->
          <div class="flex-shrink-0 flex justify-center md:block">
            <div class="relative w-28 h-28 md:w-40 md:h-40">
              <div
                class="absolute inset-0 bg-primary/30 rounded-full blur-xl animate-pulse"
              ></div>
              <img
                [src]="currentTrainer()?.avatar_url || 'assets/trainer-ai.png'"
                onerror="
                  this.src =
                    'https://api.dicebear.com/7.x/bottts/svg?seed=Atlas'
                "
                alt="Trainer"
                class="w-full h-full rounded-full border-2 border-primary/50 relative z-10 bg-dark-bg object-cover"
              />
              <div
                class="absolute -bottom-2 -right-2 bg-dark-bg px-3 py-1 rounded-full border border-primary/30 text-[10px] font-bold text-primary uppercase shadow-lg z-20"
              >
                AI Coach
              </div>
            </div>
          </div>

          <!-- Insight Text -->
          <div class="flex-1">
            <div class="flex items-center gap-3 mb-4">
              <span class="animate-pulse text-primary">●</span>
              <h2
                class="text-xs font-bold text-text-secondary uppercase tracking-widest"
                data-cy="trainer-analysis-header"
              >
                Análise de Hoje
              </h2>
            </div>

            <div
              *ngIf="metabolismService.isInsightLoading() && !metabolismService.insightText()"
              class="space-y-3 opacity-50 animate-pulse"
            >
              <div class="h-4 bg-secondary/30 rounded w-3/4"></div>
              <div class="h-4 bg-secondary/30 rounded w-1/2"></div>
            </div>

            <markdown
              [data]="metabolismService.insightText()"
              class="prose prose-invert prose-p:text-text-primary prose-p:leading-relaxed prose-p:font-light text-base md:text-lg max-w-none prose-strong:font-bold prose-strong:text-primary [&_*]:no-underline"
            >
            </markdown>

            <!-- Botão Regenerar -->
            <div class="mt-4 flex justify-end">
              <button
                (click)="regenerateInsight()"
                [disabled]="metabolismService.isInsightLoading()"
                class="text-xs text-text-secondary hover:text-primary transition-colors duration-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span>{{ metabolismService.isInsightLoading() ? 'Gerando...' : 'Regenerar análise' }}</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== CORPO SECTION ==================== -->
    <ng-container *ngIf="!isLoading()">
        <app-section-header
            title="Composição Corporal"
            subtitle="Peso, gordura e massa muscular">
        </app-section-header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Row 1 -->
            <app-widget-line-chart 
                class="lg:col-span-2"
                title="Tendência de Peso" 
                subtitle="Peso suavizado (Histórico)"
                footerLabel="Variação Total"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate"
                [chartData]="weightChartData"
                [options]="weightChartOptions">
                <div slot="header-action" class="flex items-center gap-2">
                    <span *ngIf="metabolismStats()?.expenditure_trend === 'up'" class="text-[8px] text-green-400 font-bold uppercase tracking-tighter">↑ METABOLISMO</span>
                    <span *ngIf="metabolismStats()?.expenditure_trend === 'down'" class="text-[8px] text-red-400 font-bold uppercase tracking-tighter">↓ METABOLISMO</span>
                    <span class="text-[8px] text-primary bg-primary/10 px-2 py-0.5 rounded border border-primary/20 font-bold uppercase tracking-tighter">{{ metabolismStats()?.confidence || 'Calculado' }}</span>
                </div>
                <div slot="footer-value" class="text-sm font-bold" [ngClass]="getWeightVariation() < 0 ? 'text-green-400' : 'text-red-400'">
                    {{ getWeightVariation() > 0 ? '+' : '' }}{{ getWeightVariation() | number:'1.1-1' }} kg
                </div>
            </app-widget-line-chart>

            <app-widget-tdee-summary
                class="lg:col-span-2"
                title="Seu Gasto Energético"
                [tdee]="metabolismStats()?.tdee || 0"
                [targetCalories]="metabolismStats()?.daily_target || 0"
                [goalType]="metabolismStats()?.status"
                [energyBalance]="metabolismStats()?.energy_balance || 0">
            </app-widget-tdee-summary>

            <!-- Row 2 -->
            <app-widget-body-evolution 
                class="lg:col-span-2"
                [fatChange]="metabolismStats()?.fat_change_kg" 
                [muscleChange]="metabolismStats()?.muscle_change_kg || 0"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate">
            </app-widget-body-evolution>

            <app-widget-metabolic-gauge 
                class="lg:col-span-2"
                [status]="metabolismStats()?.status || 'maintenance'" 
                [energyBalance]="metabolismStats()?.energy_balance || 0">
            </app-widget-metabolic-gauge>

            <!-- Row 3 -->
            <app-widget-line-chart 
                class="lg:col-span-2"
                title="Massa Gorda (%)" 
                subtitle="TENDÊNCIA DE PERCENTUAL"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate"
                [chartData]="fatTrendChartData"
                [options]="compositionChartOptions">
            </app-widget-line-chart>

            <app-widget-line-chart 
                class="lg:col-span-2"
                title="Massa Magra (%)" 
                subtitle="TENDÊNCIA DE PERCENTUAL"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate"
                [chartData]="muscleTrendChartData"
                [options]="compositionChartOptions">
            </app-widget-line-chart>
        </div>
    </ng-container>

    <!-- Shared loading template for widgets -->
    <ng-template #loadingMini>
       <div class="space-y-4 animate-pulse">
          <div class="h-8 bg-secondary/20 rounded w-1/2"></div>
          <div class="h-12 bg-secondary/10 rounded w-full"></div>
          <div class="h-4 bg-secondary/20 rounded w-3/4"></div>
       </div>
    </ng-template>

    <!-- ==================== NUTRIÇÃO SECTION ==================== -->
    <ng-container *ngIf="nutritionStats() as n">
        <app-section-header
            title="Alimentação"
            subtitle="Calorias, macros e aderência à dieta">
        </app-section-header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 w-full">
            <!-- Row 1: Correlation & History Side-by-Side -->
            <app-widget-calories-weight-comparison
                class="lg:col-span-2"
                title="Análise de Correlação: Calorias vs Peso"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate"
                [weightTrend]="metabolismStats()?.weight_trend || []"
                [calorieHistory]="n.last_14_days || []">
            </app-widget-calories-weight-comparison>

            <app-widget-line-chart 
                class="lg:col-span-2"
                title="Trend de Ingestão de Calorias (14 dias)" 
                subtitle="KCAL / DIA"
                [startDate]="nutritionStats()?.startDate"
                [endDate]="nutritionStats()?.endDate"
                [chartData]="lineChartData"
                [options]="lineChartOptions">
            </app-widget-line-chart>

            <!-- Row 2: Macros & Targets -->
            <app-widget-macro-targets
                class="lg:col-span-2"
                title="Performance de Macros (7 dias)"
                [avgProtein]="n.avg_protein || 0"
                [targetProtein]="n.macro_targets.protein"
                [avgCarbs]="( (n.avg_daily_calories || 0) * 0.4 / 4)"
                [targetCarbs]="n.macro_targets.carbs"
                [avgFat]="( (n.avg_daily_calories || 0) * 0.3 / 9)"
                [targetFat]="n.macro_targets.fat"
                [stabilityScore]="n.stability_score"
                [startDate]="n.startDate"
                [endDate]="n.endDate">
            </app-widget-macro-targets>

            <app-widget-macros-today 
                class="lg:col-span-2"
                [calories]="n.today?.calories || 0" 
                [protein]="n.today?.protein_grams || 0" 
                [carbs]="n.today?.carbs_grams || 0" 
                [fat]="n.today?.fat_grams || 0">
            </app-widget-macros-today>
        </div>
    </ng-container>

    <!-- ==================== TREINOS SECTION ==================== -->
    <ng-container *ngIf="!isLoading() && stats() as s">
        <app-section-header
            title="Desempenho"
            subtitle="Volume, PRs e frequência">
        </app-section-header>

        <!-- Grid 1: Performance Summary -->
        <!-- Main Data Grid -->
        <!-- Main Data Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Training Performance -->
            <app-widget-recent-prs class="lg:col-span-2" [prs]="s.recent_prs"></app-widget-recent-prs>

            <app-widget-last-activity [lastWorkout]="s.last_workout"></app-widget-last-activity>

            <app-widget-weekly-distribution [volumeStats]="s.volume_by_category || []"></app-widget-weekly-distribution>

            <!-- Volume Trend (Wide) -->
            <app-widget-line-chart 
                class="lg:col-span-4"
                title="Evolução de Volume Total de Carga (8 semanas)" 
                subtitle="CARGA ACUMULADA (KG POR SEMANA)"
                [chartData]="volumeTrendChartData"
                [options]="volumeTrendChartOptions">
            </app-widget-line-chart>
        </div>
    </ng-container>

        <!-- ==================== ESTATÍSTICAS E CONSISTÊNCIA ==================== -->
        <app-section-header
            title="Qualidade dos Dados"
            subtitle="Confiabilidade das suas métricas">
        </app-section-header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 w-full col-span-full">
            <!-- Training Stats Group -->
            @if (stats(); as s) {
                <app-widget-streak title="Sequência de Treinos" [streakWeeks]="s.current_streak_weeks"></app-widget-streak>
                <app-widget-frequency title="Treinos Esta Semana" [weeklyFrequency]="s.weekly_frequency"></app-widget-frequency>
            }

            <!-- Nutrition Stats Group -->
            @if (nutritionStats(); as n) {
                <app-widget-adherence title="Meta Calórica Atingida" [weeklyAdherence]="n.weekly_adherence"></app-widget-adherence>

                <app-widget-calorie-volatility [variance]="120"></app-widget-calorie-volatility>
            }

            <!-- Weight Log Stats (Wide) -->
            <app-widget-weight-histogram
                class="lg:col-span-2"
                [consistency]="metabolismStats()?.consistency || []">
            </app-widget-weight-histogram>

            <!-- Global Confidence Info -->
            <app-widget-data-quality
                class="lg:col-span-2"
                [consistencyScore]="metabolismStats()?.consistency_score || 0"
                [weightLogsCount]="metabolismStats()?.weight_logs_count || 0">
            </app-widget-data-quality>
        </div>

</div>
