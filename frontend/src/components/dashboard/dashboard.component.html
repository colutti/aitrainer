<div class="h-full overflow-y-auto p-6 bg-dark-bg text-text-primary">
  <h1 class="text-3xl font-bold mb-6 tracking-tight">Dashboard</h1>
  
  <div *ngIf="isLoading()" class="flex justify-center items-center h-64">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
  </div>

  <div class="space-y-8 p-1">
    
    <!-- AI Insight (HERO) -->
    <div class="mb-4" *ngIf="metabolismStats()?.confidence !== 'none'">
      <div
        class="bg-light-bg rounded-2xl border border-primary/20 p-[1px] shadow-2xl relative overflow-hidden group"
      >
        <!-- Animated shine effect -->
        <div
          class="absolute inset-0 bg-gradient-to-r from-transparent via-primary/10 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000 ease-out pointer-events-none z-10"
        ></div>

        <div
          class="bg-dark-bg/50 backdrop-blur-sm rounded-2xl p-6 md:p-8 flex flex-col md:flex-row gap-8 relative z-0 h-full"
        >
          <!-- Trainer Avatar & Pulse -->
          <div class="flex-shrink-0 flex justify-center md:block">
            <div class="relative w-24 h-24 md:w-32 md:h-32">
              <div
                class="absolute inset-0 bg-primary/20 rounded-full blur-xl animate-pulse"
              ></div>
              <img
                [src]="currentTrainer()?.avatar_url || 'assets/trainer-ai.png'"
                onerror="
                  this.src =
                    'https://api.dicebear.com/7.x/bottts/svg?seed=Atlas'
                "
                alt="Trainer"
                class="w-full h-full rounded-full border-2 border-primary/50 relative z-10 bg-dark-bg object-cover"
              />
              <div
                class="absolute -bottom-2 -right-2 bg-dark-bg px-3 py-1 rounded-full border border-primary/30 text-[10px] font-bold text-primary uppercase shadow-lg z-20"
              >
                AI Coach
              </div>
            </div>
          </div>

          <!-- Insight Text -->
          <div class="flex-1">
            <div class="flex items-center gap-3 mb-4">
              <span class="animate-pulse text-primary">‚óè</span>
              <h2
                class="text-xs font-bold text-text-secondary uppercase tracking-widest"
                data-cy="trainer-analysis-header"
              >
                An√°lise de Hoje
              </h2>
            </div>

            <div
              *ngIf="metabolismService.isInsightLoading() && !metabolismService.insightText()"
              class="space-y-3 opacity-50 animate-pulse"
            >
              <div class="h-4 bg-secondary/30 rounded w-3/4"></div>
              <div class="h-4 bg-secondary/30 rounded w-1/2"></div>
            </div>

            <markdown
              [data]="metabolismService.insightText()"
              class="prose prose-invert prose-p:text-text-primary prose-p:leading-relaxed prose-p:font-light text-base md:text-lg max-w-none prose-strong:font-bold prose-strong:text-primary [&_*]:no-underline"
            >
            </markdown>

            <div
              class="mt-6 flex items-center gap-4 text-xs text-text-secondary font-mono border-t border-secondary/30 pt-4"
            >
              <span>Modelo: v3.5-Turbo</span>
              <span>‚Ä¢</span>
              <span
                >Calibrado com {{ metabolismStats()?.weight_logs_count }} pontos de
                dados</span
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== CORPO SECTION ==================== -->
    <ng-container *ngIf="!isLoading()">
        <div class="col-span-full flex items-center gap-4 mt-2 mb-2">
            <h2 class="text-lg font-bold text-text-secondary flex items-center gap-2">
                <span>‚öñÔ∏è</span>
                <span>Corpo</span>
            </h2>
            <div class="flex-1 h-px bg-secondary/30"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Row 1 -->
            <app-widget-line-chart 
                class="lg:col-span-2"
                title="Tend√™ncia de Peso" 
                subtitle="Peso suavizado (Hist√≥rico)"
                footerLabel="Varia√ß√£o Total"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate"
                [chartData]="weightChartData"
                [options]="weightChartOptions">
                <div slot="header-action" class="flex items-center gap-2">
                    <span *ngIf="metabolismStats()?.expenditure_trend === 'up'" class="text-[8px] text-green-400 font-bold uppercase tracking-tighter">‚Üë METABOLISMO</span>
                    <span *ngIf="metabolismStats()?.expenditure_trend === 'down'" class="text-[8px] text-red-400 font-bold uppercase tracking-tighter">‚Üì METABOLISMO</span>
                    <span class="text-[8px] text-primary bg-primary/10 px-2 py-0.5 rounded border border-primary/20 font-bold uppercase tracking-tighter">{{ metabolismStats()?.confidence || 'Calculado' }}</span>
                </div>
                <div slot="footer-value" class="text-sm font-bold" [ngClass]="getWeightVariation() < 0 ? 'text-green-400' : 'text-red-400'">
                    {{ getWeightVariation() > 0 ? '+' : '' }}{{ getWeightVariation() | number:'1.1-1' }} kg
                </div>
            </app-widget-line-chart>

            <app-widget-tdee-summary 
                class="lg:col-span-2"
                [tdee]="metabolismStats()?.tdee || 0" 
                [targetCalories]="metabolismStats()?.daily_target || 0"
                [goalType]="metabolismStats()?.status"
                [energyBalance]="metabolismStats()?.energy_balance || 0">
            </app-widget-tdee-summary>

            <!-- Row 2 -->
            <app-widget-body-evolution 
                class="lg:col-span-2"
                [fatChange]="metabolismStats()?.fat_change_kg" 
                [muscleChange]="metabolismStats()?.muscle_change_kg || 0"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate">
            </app-widget-body-evolution>

            <app-widget-metabolic-gauge 
                class="lg:col-span-2"
                [status]="metabolismStats()?.status || 'maintenance'" 
                [energyBalance]="metabolismStats()?.energy_balance || 0">
            </app-widget-metabolic-gauge>

            <!-- Row 3 -->
            <app-widget-line-chart 
                class="lg:col-span-2"
                title="Massa Gorda (%)" 
                subtitle="TEND√äNCIA DE PERCENTUAL"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate"
                [chartData]="fatTrendChartData"
                [options]="compositionChartOptions">
            </app-widget-line-chart>

            <app-widget-line-chart 
                class="lg:col-span-2"
                title="Massa Magra (%)" 
                subtitle="TEND√äNCIA DE PERCENTUAL"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate"
                [chartData]="muscleTrendChartData"
                [options]="compositionChartOptions">
            </app-widget-line-chart>
        </div>
    </ng-container>

    <!-- Shared loading template for widgets -->
    <ng-template #loadingMini>
       <div class="space-y-4 animate-pulse">
          <div class="h-8 bg-secondary/20 rounded w-1/2"></div>
          <div class="h-12 bg-secondary/10 rounded w-full"></div>
          <div class="h-4 bg-secondary/20 rounded w-3/4"></div>
       </div>
    </ng-template>

    <!-- ==================== NUTRI√á√ÉO SECTION ==================== -->
    <ng-container *ngIf="nutritionStats() as n">
        <!-- Header -->
        <div class="col-span-full flex items-center gap-4 mt-6 mb-2">
            <h2 class="text-lg font-bold text-text-secondary flex items-center gap-2">
                <span>üçΩÔ∏è</span>
                <span>Nutri√ß√£o</span>
            </h2>
            <div class="flex-1 h-px bg-secondary/30"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 w-full">
            <!-- Nutrition Correlation (Wide) -->
            <app-widget-calories-weight-comparison
                class="lg:col-span-4"
                title="An√°lise de Correla√ß√£o: Calorias vs Peso"
                [startDate]="metabolismStats()?.startDate"
                [endDate]="metabolismStats()?.endDate"
                [weightTrend]="metabolismStats()?.weight_trend || []"
                [calorieHistory]="n.last_14_days || []">
            </app-widget-calories-weight-comparison>

            <!-- Row 2 -->
            <app-widget-macro-targets
                class="lg:col-span-2"
                title="Performance de Macros (7 dias)"
                [avgProtein]="n.avg_protein || 0"
                [targetProtein]="n.macro_targets.protein"
                [avgCarbs]="( (n.avg_daily_calories || 0) * 0.4 / 4)"
                [targetCarbs]="n.macro_targets.carbs"
                [avgFat]="( (n.avg_daily_calories || 0) * 0.3 / 9)"
                [targetFat]="n.macro_targets.fat"
                [stabilityScore]="n.stability_score"
                [startDate]="n.startDate"
                [endDate]="n.endDate">
            </app-widget-macro-targets>

            <app-widget-macros-today 
                class="lg:col-span-2"
                [calories]="n.today?.calories || 0" 
                [protein]="n.today?.protein_grams || 0" 
                [carbs]="n.today?.carbs_grams || 0" 
                [fat]="n.today?.fat_grams || 0">
            </app-widget-macros-today>

            <!-- History Trend (Wide) -->
            <app-widget-line-chart 
                class="lg:col-span-4"
                title="Trend de Ingest√£o de Calorias (14 dias)" 
                subtitle="KCAL / DIA"
                [startDate]="nutritionStats()?.startDate"
                [endDate]="nutritionStats()?.endDate"
                [chartData]="lineChartData"
                [options]="lineChartOptions">
            </app-widget-line-chart>
        </div>
    </ng-container>

    <!-- ==================== TREINOS SECTION ==================== -->
    <ng-container *ngIf="!isLoading() && stats() as s">
        <!-- Header -->
        <div class="col-span-full flex items-center gap-4 mt-6 mb-2">
            <h2 class="text-lg font-bold text-text-secondary flex items-center gap-2">
                <span>üèãÔ∏è</span>
                <span>Treinos</span>
            </h2>
            <div class="flex-1 h-px bg-secondary/30"></div>
        </div>

        <!-- Grid 1: Performance Summary -->
        <!-- Main Data Grid -->
        <!-- Main Data Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Training Performance -->
            <app-widget-recent-prs class="lg:col-span-2" [prs]="s.recent_prs"></app-widget-recent-prs>
            
            <div class="bg-light-bg p-4 rounded-2xl border border-secondary shadow-lg hover:border-primary/50 transition-colors duration-300 relative overflow-hidden flex flex-col justify-center min-h-[90px]">
                <div class="absolute top-0 right-0 p-3 opacity-5">
                    <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg>
                </div>
                <p class="text-text-secondary text-[8px] font-bold uppercase tracking-widest mb-1.5 line-clamp-1">√öltima Atividade</p>
                <div *ngIf="s.last_workout; else noWorkout">
                    <h3 class="text-sm font-black text-white mb-0.5 whitespace-nowrap overflow-hidden text-ellipsis">{{ s.last_workout.workout_type || 'Treino' }}</h3>
                    <p class="text-[8px] text-primary font-bold uppercase tracking-tight">{{ getFormattedDate(s.last_workout.date) }} ‚Ä¢ {{ s.last_workout.duration_minutes || '--' }} min </p>
                </div>
                <ng-template #noWorkout>
                    <p class="text-text-secondary italic text-[9px]">Sem treinos.</p>
                </ng-template>
            </div>

            <div class="bg-light-bg p-4 rounded-2xl border border-secondary shadow-lg hover:border-primary/50 transition-colors duration-300">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-text-secondary text-[10px] font-bold uppercase tracking-wider">Distribui√ß√£o Semanal</p>
                    <span class="bg-primary/10 text-primary text-[8px] px-2 py-0.5 rounded-full border border-primary/20 font-bold uppercase">Volume Kg</span>
                </div>
                <div class="h-32 w-full">
                    <canvas baseChart [data]="barChartData" [options]="barChartOptions" [type]="barChartType"></canvas>
                </div>
            </div>

            <!-- Volume Trend (Wide) -->
            <app-widget-line-chart 
                class="lg:col-span-4"
                title="Evolu√ß√£o de Volume Total de Carga (8 semanas)" 
                subtitle="CARGA ACUMULADA (KG POR SEMANA)"
                [chartData]="volumeTrendChartData"
                [options]="volumeTrendChartOptions">
            </app-widget-line-chart>
        </div>
    </ng-container>

        <!-- ==================== ESTAT√çSTICAS E CONSIST√äNCIA ==================== -->
        <div class="col-span-full flex items-center gap-4 mt-8 mb-2">
            <h2 class="text-lg font-bold text-text-secondary flex items-center gap-2">
                <span>üìä</span>
                <span>Estat√≠sticas e Consist√™ncia</span>
            </h2>
            <div class="flex-1 h-px bg-secondary/30"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 w-full col-span-full">
            <!-- Training Stats Group -->
            @if (stats(); as s) {
                <app-widget-streak title="Consist√™ncia de Treino (Semanas)" [streakWeeks]="s.current_streak_weeks"></app-widget-streak>
                <app-widget-frequency title="Frequ√™ncia de Treino (7 dias)" [weeklyFrequency]="s.weekly_frequency"></app-widget-frequency>
            }

            <!-- Nutrition Stats Group -->
            @if (nutritionStats(); as n) {
                <app-widget-adherence title="Ader√™ncia √† Dieta (7 dias)" [weeklyAdherence]="n.weekly_adherence"></app-widget-adherence>
                
                <div class="bg-light-bg p-4 rounded-2xl border border-secondary shadow-lg flex flex-col justify-center items-center text-center relative overflow-hidden group min-h-[100px]">
                    <div class="absolute -top-10 -right-10 w-24 h-24 bg-primary/5 rounded-full blur-2xl group-hover:bg-primary/10 transition-colors"></div>
                    <p class="text-text-secondary text-[9px] font-bold uppercase tracking-wider mb-1">Volatilidade Cal√≥rica (7d)</p>
                    <div class="flex items-center gap-3">
                        <span class="text-xl">‚öñÔ∏è</span>
                        <div class="text-left">
                            <p class="text-xs font-black text-white">Est√°vel</p>
                            <p class="text-[8px] text-text-secondary uppercase tracking-tighter">Vari√¢ncia <span class="text-primary font-bold">¬±120kcal</span></p>
                        </div>
                    </div>
                </div>
            }

            <!-- Weight Log Stats (Wide) -->
            <div class="lg:col-span-2 bg-light-bg p-4 rounded-2xl border border-secondary shadow-lg hover:border-primary/50 transition-colors duration-300">
                 <div class="flex justify-between items-center mb-4">
                     <p class="text-text-secondary text-[10px] font-bold uppercase tracking-wider">Histograma de Registro de Peso (30 dias)</p>
                     <div class="flex gap-2">
                         <span class="w-1.5 h-1.5 rounded-full bg-[#10b981]"></span>
                         <span class="w-1.5 h-1.5 rounded-full bg-[#3b82f6]"></span>
                     </div>
                 </div>
                 <div class="h-28 w-full">
                    <canvas baseChart [data]="consistencyChartData" [options]="consistencyChartOptions" [type]="consistencyChartType"></canvas>
                 </div>
            </div>

            <!-- Global Confidence Info -->
            <div class="lg:col-span-2 bg-light-bg p-4 rounded-2xl border border-secondary shadow-lg hover:border-primary/50 transition-colors flex flex-col justify-center text-center group">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary/0 via-primary/40 to-primary/0 scale-x-0 group-hover:scale-x-100 transition-transform duration-500"></div>
                <p class="text-text-secondary text-[10px] font-bold uppercase tracking-wider mb-2">Qualidade Global dos Dados</p>
                <div class="flex items-center justify-center gap-4">
                    <span class="text-4xl font-black text-primary">{{ metabolismStats()?.consistency_score || 0 }}%</span>
                    <div class="text-left">
                        <p class="text-[10px] text-text-secondary uppercase font-bold">N√≠vel de Confian√ßa</p>
                        <p class="text-[10px] text-white font-medium opacity-60">Baseado em {{ metabolismStats()?.weight_logs_count || 0 }} pesagens</p>
                    </div>
                </div>
            </div>
        </div>

</div>
