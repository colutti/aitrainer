<div class="h-full overflow-y-auto p-8 bg-dark-bg text-text-primary">
  <h1 class="text-3xl font-bold mb-8 tracking-tight">Seu Metabolismo</h1>

  <!-- Loading State -->
  <div *ngIf="isLoading()" class="flex justify-center items-center h-64">
    <div
      class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"
    ></div>
  </div>

  <ng-container *ngIf="!isLoading()">
    <!-- Date Range Header -->
    <div class="flex items-center justify-between mb-6">
      <div
        class="flex items-center gap-3 bg-light-bg px-4 py-2 rounded-full border border-white/10"
      >
        <span
          class="text-xs font-bold text-text-secondary uppercase tracking-widest hidden md:inline"
          >Período Analisado</span
        >
        <span class="text-white font-bold text-sm">
          {{ stats()?.startDate | date: "dd MMM" }} -
          {{ stats()?.endDate | date: "dd MMM" }}
        </span>
        <span
          class="text-xs text-green-400 bg-green-400/10 px-2 py-0.5 rounded-full border border-green-400/20"
          data-cy="logs-count"
        >
          {{ stats()?.logs_count }} dias
        </span>
      </div>

      <div
        class="flex items-center gap-2 text-xs text-secondary cursor-pointer hover:text-white transition-colors"
      >
        <span>⚙️ Configurar Preferências</span>
      </div>
    </div>

    <!-- Row 1: Status & Small Metrics (4x1) -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- TDEE Summary -->
      <app-widget-tdee-summary
        class="lg:col-span-1"
        [tdee]="stats()?.tdee || 0"
        [targetCalories]="stats()?.daily_target || 0"
        [goalType]="stats()?.goal_type"
      >
      </app-widget-tdee-summary>

      <!-- Metabolic Phase -->
      <app-widget-metabolic-gauge
        class="lg:col-span-1"
        [status]="stats()?.status || 'maintenance'"
        [energyBalance]="stats()?.energy_balance || 0"
      >
      </app-widget-metabolic-gauge>

      <!-- TDEE Confidence -->
      <div
        class="lg:col-span-1 bg-light-bg rounded-2xl border border-secondary p-4 flex flex-col justify-between shadow-lg hover:border-primary/50 transition-colors h-full"
      >
        <div class="flex justify-between items-center mb-2">
          <h3
            class="text-text-secondary text-[10px] font-bold uppercase tracking-wider"
          >
            Confiança
          </h3>
          <div
            class="text-[9px] font-bold uppercase px-1.5 py-0.5 rounded border"
            [ngClass]="getConfidenceColor(stats()?.confidence)"
          >
            {{ stats()?.confidence || "N/A" }}
          </div>
        </div>
        <div class="flex flex-col items-center justify-center flex-1 py-1">
          <div class="relative w-24 h-12 overflow-hidden mb-1">
            <div
              class="absolute w-24 h-24 rounded-full border-[8px] border-secondary/30 border-t-2 border-l-2 -rotate-45"
            ></div>
            <div
              class="absolute w-24 h-24 rounded-full border-[8px] border-transparent border-t-[var(--color-gauge)] border-r-[var(--color-gauge)] -rotate-45 transition-all duration-1000"
              [style.--color-gauge]="getConfidenceColorHex(stats()?.confidence)"
              [style.clip-path]="
                stats()?.confidence === 'high'
                  ? 'inset(0 0 50% 0)'
                  : stats()?.confidence === 'medium'
                    ? 'inset(0 25% 50% 0)'
                    : 'inset(0 70% 50% 0)'
              "
            ></div>
          </div>
        </div>
        <p class="text-[9px] text-text-secondary leading-tight text-center">
          {{ getConfidenceReason(stats()) }}
        </p>
      </div>

      <!-- Quick Consistency Stat -->
      <div
        class="lg:col-span-1 bg-light-bg rounded-2xl border border-secondary p-4 flex flex-col justify-center items-center shadow-lg hover:border-primary/50 transition-colors h-full"
      >
        <p
          class="text-text-secondary text-[10px] font-bold uppercase tracking-wider mb-2 w-full text-left"
        >
          Consistência
        </p>
        <div class="text-3xl font-black text-primary">
          {{ stats()?.consistency_score }}%
        </div>
        <p class="text-[9px] text-text-secondary uppercase font-bold mt-1">
          Dados Confiáveis
        </p>
      </div>
    </div>

    <!-- Row 2: Trend Charts (2x2) -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
      <!-- Weight Trend Chart -->
      <app-widget-line-chart
        class="lg:col-span-2"
        style="height: 245px; display: block"
        title="Tendência de Peso"
        subtitle="Suavizado (30 dias)"
        footerLabel="Variação Total"
        [startDate]="stats()?.startDate"
        [endDate]="stats()?.endDate"
        [chartData]="weightChartData"
        [options]="weightChartOptions"
      >
        <div
          slot="footer-value"
          class="text-xs font-bold"
          [ngClass]="
            stats()?.end_weight - stats()?.start_weight < 0
              ? 'text-green-400'
              : 'text-red-400'
          "
        >
          {{ stats()?.end_weight - stats()?.start_weight > 0 ? "+" : ""
          }}{{
            stats()?.end_weight - stats()?.start_weight | number: "1.1-1"
          }}
          kg
        </div>
      </app-widget-line-chart>

      <!-- Comparative Analytics -->
      <app-widget-calories-weight-comparison
        class="lg:col-span-2"
        style="height: 245px; display: block"
        [startDate]="stats()?.startDate"
        [endDate]="stats()?.endDate"
        [weightTrend]="stats()?.weight_trend || []"
        [calorieHistory]="nutritionService.stats()?.last_14_days || []"
      >
      </app-widget-calories-weight-comparison>
    </div>

    <!-- Row 3: Transparency & Details -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Transparency Card -->
      <div
        class="lg:col-span-2 bg-light-bg rounded-2xl border border-secondary p-6 relative overflow-hidden shadow-lg hover:border-primary/50 transition-colors h-full"
      >
        <h3
          class="text-text-secondary text-xs font-bold uppercase tracking-wider mb-6"
        >
          Qualidade e Transparência
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div
            class="bg-black/20 rounded-xl p-3 border border-secondary/30 text-center"
          >
            <div class="text-2xl font-bold text-blue-400 mb-1">
              {{ stats()?.weight_logs_count }}
            </div>
            <div class="text-[10px] text-text-secondary uppercase font-bold">
              Pesagens
            </div>
          </div>
          <div
            class="bg-black/20 rounded-xl p-3 border border-primary/20 text-center"
          >
            <div class="text-2xl font-bold text-primary mb-1">
              {{ stats()?.consistency_score }}%
            </div>
            <div class="text-[10px] text-text-secondary uppercase font-bold">
              Constância
            </div>
          </div>
          <div
            class="bg-black/20 rounded-xl p-3 border border-red-500/10 text-center"
          >
            <div class="text-2xl font-bold text-red-400 mb-1">
              {{ stats()?.outliers_count || 0 }}
            </div>
            <div class="text-[10px] text-text-secondary uppercase font-bold">
              Outliers
            </div>
          </div>
          <div
            class="bg-black/20 rounded-xl p-3 border border-secondary/30 text-center"
          >
            <div class="text-xs font-bold text-white mb-1">
              {{ stats()?.logs_count }} d
            </div>
            <div class="text-[10px] text-text-secondary uppercase font-bold">
              Janela
            </div>
          </div>
        </div>

        <!-- Heatmap -->
        <div>
          <div class="flex justify-between items-center mb-3">
            <h4
              class="text-[10px] font-bold text-text-secondary uppercase tracking-widest"
            >
              Histórico de Frequência
            </h4>
            <div class="flex gap-2 items-center">
              <div class="flex items-center gap-1">
                <div class="w-1.5 h-1.5 rounded-sm bg-blue-500/50"></div>
                <span class="text-[7px] text-text-secondary font-bold"
                  >PESO</span
                >
              </div>
              <div class="flex items-center gap-1">
                <div class="w-1.5 h-1.5 rounded-sm bg-green-500/50"></div>
                <span class="text-[7px] text-text-secondary font-bold"
                  >DIETA</span
                >
              </div>
            </div>
          </div>
          <div class="flex flex-wrap gap-1">
            <div
              *ngFor="let day of stats()?.consistency"
              class="w-3.5 h-3.5 rounded-sm transition-all duration-300"
              [ngClass]="{
                'bg-gray-800': !day.weight && !day.nutrition,
                'bg-blue-500/40': day.weight && !day.nutrition,
                'bg-green-500/40': !day.weight && day.nutrition,
                'bg-cyan-400 shadow-[0_0_8px_rgba(34,211,238,0.4)]':
                  day.weight && day.nutrition,
              }"
              [title]="day.date"
            ></div>
          </div>
        </div>

        <!-- Algorithm Info -->
        <div class="mt-4 pt-4 border-t border-secondary/30">
          <p class="text-[9px] text-text-secondary leading-relaxed">
            <strong>Metodologia:</strong> O cálculo de TDEE utiliza regressão
            linear ponderada. Variações acima de 1kg/dia são filtradas como
            anomalias transientes.
          </p>
        </div>
      </div>

      <!-- Body Composition -->
      <div
        class="lg:col-span-2 bg-light-bg rounded-2xl border border-secondary p-6 flex flex-col justify-center shadow-lg hover:border-primary/50 transition-colors"
      >
        <h3
          class="text-text-secondary text-xs font-bold uppercase tracking-wider mb-4"
        >
          Composição Corporal
        </h3>
        <div *ngIf="stats()?.fat_change_kg" class="space-y-6">
          <div>
            <div class="flex justify-between text-xs mb-2">
              <span class="text-text-secondary"
                >Gordura
                {{
                  stats()?.end_fat_pct ? "(" + stats()?.end_fat_pct + "%)" : ""
                }}</span
              >
              <span
                class="font-bold"
                [ngClass]="
                  stats()?.fat_change_kg < 0 ? 'text-green-400' : 'text-red-400'
                "
              >
                {{ stats()?.fat_change_kg > 0 ? "↑ +" : "↓"
                }}{{ stats()?.fat_change_kg }} kg
              </span>
            </div>
            <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
              <div
                class="h-full bg-yellow-500/50 rounded-full"
                [style.width.%]="stats()?.end_fat_pct || 20"
              ></div>
            </div>
          </div>
          <div>
            <div class="flex justify-between text-xs mb-2">
              <span class="text-text-secondary"
                >Massa Muscular
                {{
                  stats()?.end_muscle_pct
                    ? "(" + stats()?.end_muscle_pct + "%)"
                    : ""
                }}</span
              >
              <span
                class="font-bold"
                [ngClass]="
                  stats()?.muscle_change_kg > 0
                    ? 'text-green-400'
                    : 'text-text-secondary'
                "
              >
                {{ stats()?.muscle_change_kg > 0 ? "↑ +" : "↓"
                }}{{ stats()?.muscle_change_kg }} kg
              </span>
            </div>
            <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
              <div
                class="h-full bg-primary/40 rounded-full"
                [style.width.%]="stats()?.end_muscle_pct || 40"
              ></div>
            </div>
          </div>
        </div>
        <div
          *ngIf="!stats()?.fat_change_kg"
          class="text-center py-8 opacity-50"
        >
          <span class="text-2xl grayscale">⚖️</span>
          <p class="text-xs mt-2">Sem dados de % Gordura</p>
        </div>
      </div>
    </div>

    <!-- Empty State / Education-->
    <div
      *ngIf="stats()?.confidence === 'none'"
      class="mt-8 p-6 bg-light-bg border border-secondary rounded-xl flex items-start gap-4"
    >
      <span class="text-2xl">ℹ️</span>
      <div>
        <h3 class="text-white font-bold text-sm mb-1">
          Como funciona a calibração?
        </h3>
        <p class="text-text-secondary text-sm">
          Pelo menos 7 dias de dados consistentes são necessários para calibrar
          seu metabolismo.
        </p>
      </div>
    </div>
  </ng-container>
</div>
