<div class="h-full overflow-y-auto p-8 bg-dark-bg text-text-primary">
  <h1 class="text-3xl font-bold mb-8 tracking-tight">Seu Metabolismo</h1>

  <!-- Loading State -->
  <div *ngIf="isLoading()" class="flex justify-center items-center h-64">
    <div
      class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"
    ></div>
  </div>

  <ng-container *ngIf="!isLoading()">
    <!-- Date Range Header -->
    <div class="flex items-center justify-between mb-6">
      <div
        class="flex items-center gap-3 bg-light-bg px-4 py-2 rounded-full border border-white/10"
      >
        <span
          class="text-xs font-bold text-text-secondary uppercase tracking-widest hidden md:inline"
          >Período Analisado</span
        >
        <span class="text-white font-bold text-sm">
          {{ stats()?.startDate | date: "dd MMM" }} -
          {{ stats()?.endDate | date: "dd MMM" }}
        </span>
        <span
          class="text-xs text-green-400 bg-green-400/10 px-2 py-0.5 rounded-full border border-green-400/20"
          data-cy="logs-count"
        >
          {{ stats()?.logs_count }} dias
        </span>
      </div>

      <div
        class="flex items-center gap-2 text-xs text-secondary cursor-pointer hover:text-white transition-colors"
      >
        <span>⚙️ Configurar Preferências</span>
      </div>
    </div>


    <!-- Widgets Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- W0: TDEE Summary (New) -->
      <app-widget-tdee-summary
        [tdee]="stats()?.tdee || 0"
        [targetCalories]="stats()?.daily_target || 0"
        [goalType]="stats()?.status"
        [energyBalance]="stats()?.energy_balance || 0">
      </app-widget-tdee-summary>

      <!-- W1: Metabolic Phase Gauge -->
      <app-widget-metabolic-gauge 
        [status]="stats()?.status || 'maintenance'" 
        [energyBalance]="stats()?.energy_balance || 0">
      </app-widget-metabolic-gauge>

      <!-- W2: TDEE Confidence (Keep local as it has unique gauge) -->
      <div
        class="bg-light-bg rounded-2xl border border-secondary p-6 flex flex-col justify-between shadow-lg hover:border-primary/50 transition-colors"
      >
        <div class="flex justify-between items-start mb-2">
          <h3
            class="text-text-secondary text-xs font-bold uppercase tracking-wider"
          >
            Confiança do TDEE
          </h3>
          <div class="text-text-secondary">•••</div>
        </div>

        <div class="flex flex-col items-center justify-center flex-1 py-4">
          <div class="relative w-40 h-20 overflow-hidden mb-2">
            <div
              class="absolute w-40 h-40 rounded-full border-[12px] border-secondary/30 border-t-transparent border-l-transparent -rotate-45"
              style="
                border-top-color: transparent;
                border-left-color: transparent;
              "
            ></div>
            <div
              class="absolute w-40 h-40 rounded-full border-[12px] border-transparent border-t-[var(--color-gauge)] border-r-[var(--color-gauge)] -rotate-45 transition-all duration-1000"
              [style.--color-gauge]="getConfidenceColorHex(stats()?.confidence)"
              [style.clip-path]="
                stats()?.confidence === 'high'
                  ? 'inset(0 0 50% 0)'
                  : stats()?.confidence === 'medium'
                    ? 'inset(0 25% 50% 0)'
                    : 'inset(0 70% 50% 0)'
              "
            ></div>
          </div>
          <span
            class="text-xl font-bold uppercase tracking-widest"
            [ngClass]="getConfidenceColor(stats()?.confidence)"
          >
            {{ stats()?.confidence || "NONE" }}
          </span>
        </div>

        <div
          class="bg-black/20 rounded-lg p-3 text-center border border-secondary/30"
        >
          <p class="text-[10px] text-text-secondary">
            {{ getConfidenceReason(stats()) }}
          </p>
        </div>
      </div>

      <!-- W3: Weight Trend -->
      <app-widget-line-chart 
        title="Tendência de Peso" 
        subtitle="Peso suavizado (30 dias)"
        footerLabel="Variação no Período"
        class="h-64 md:h-auto"
        [startDate]="stats()?.startDate"
        [endDate]="stats()?.endDate"
        [chartData]="weightChartData"
        [options]="weightChartOptions">
        <div slot="footer-value" class="text-xs font-bold" [ngClass]="(stats()?.end_weight - stats()?.start_weight) < 0 ? 'text-green-400' : 'text-red-400'">
            {{ (stats()?.end_weight - stats()?.start_weight) > 0 ? '+' : '' }}{{ (stats()?.end_weight - stats()?.start_weight) | number: '1.1-1' }} kg
        </div>
      </app-widget-line-chart>
    </div>

    <!-- Comparative Analytics -->
    <div class="mb-8">
        <app-widget-calories-weight-comparison
            class="h-64"
            [startDate]="stats()?.startDate"
            [endDate]="stats()?.endDate"
            [weightTrend]="stats()?.weight_trend || []"
            [calorieHistory]="nutritionService.stats()?.last_14_days || []">
        </app-widget-calories-weight-comparison>
    </div>

    <!-- ROW 3: Transparency & Body Comp -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Transparency Chart Content -->
      <div
        class="lg:col-span-2 bg-light-bg rounded-2xl border border-secondary p-6 relative overflow-hidden shadow-lg hover:border-primary/50 transition-colors"
      >
        <h3
          class="text-text-secondary text-xs font-bold uppercase tracking-wider mb-6"
          data-cy="transparency-title"
        >
          Transparência dos Dados
        </h3>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <!-- Weight Points -->
          <div class="bg-black/20 rounded-xl p-3 border border-secondary/30">
            <div class="text-2xl font-bold text-blue-400 mb-1">
              {{ stats()?.weight_logs_count }}
            </div>
            <div class="text-[10px] text-text-secondary uppercase font-bold">
              Pesagens
            </div>
          </div>
          <!-- Consistency Score -->
          <div class="bg-black/20 rounded-xl p-3 border border-primary/20">
            <div class="text-2xl font-bold text-primary mb-1">
              {{ stats()?.consistency_score }}%
            </div>
            <div class="text-[10px] text-text-secondary uppercase font-bold">
              Constância
            </div>
          </div>
          <!-- Outliers -->
          <div
            class="bg-black/20 rounded-xl p-3 border border-red-500/10 hover:border-red-500/30 transition-colors"
          >
            <div class="text-2xl font-bold text-red-400 mb-1">
              {{ stats()?.outliers_count || 0 }}
            </div>
            <div class="text-[10px] text-text-secondary uppercase font-bold">
              Outliers Ignorados
            </div>
          </div>
          <!-- Date Range -->
          <div class="bg-black/20 rounded-xl p-3 border border-secondary/30">
            <div class="text-xs font-bold text-white mb-1">
              {{ stats()?.logs_count }} dias
            </div>
            <div class="text-[10px] text-text-secondary uppercase font-bold">
              Janela Total
            </div>
          </div>
        </div>

        <!-- Heatmap -->
        <div class="mb-6">
          <div class="flex justify-between items-center mb-3">
            <h4
              class="text-[10px] font-bold text-text-secondary uppercase tracking-widest"
            >
              Consistência (Últimos 28 dias)
            </h4>
            <div class="flex gap-2 items-center">
              <div class="flex items-center gap-1">
                <div class="w-2 h-2 rounded-sm bg-blue-500/50"></div>
                <span class="text-[8px] text-text-secondary">Peso</span>
              </div>
              <div class="flex items-center gap-1">
                <div class="w-2 h-2 rounded-sm bg-green-500/50"></div>
                <span class="text-[8px] text-text-secondary">Dieta</span>
              </div>
              <div class="flex items-center gap-1">
                <div class="w-2 h-2 rounded-sm bg-cyan-400"></div>
                <span class="text-[8px] text-text-secondary">Ambos</span>
              </div>
            </div>
          </div>
          <div class="flex flex-wrap gap-1.5">
            <div
              *ngFor="let day of stats()?.consistency"
              class="w-4 h-4 rounded-sm transition-all duration-300 hover:scale-110 cursor-help relative group"
              [ngClass]="{
                'bg-gray-800': !day.weight && !day.nutrition,
                'bg-blue-500/40': day.weight && !day.nutrition,
                'bg-green-500/40': !day.weight && day.nutrition,
                'bg-cyan-400 shadow-[0_0_8px_rgba(34,211,238,0.4)]':
                  day.weight && day.nutrition,
              }"
              [title]="day.date"
            >
              <!-- Tooltip logic if needed -->
            </div>
          </div>
        </div>

        <p class="text-[10px] text-text-secondary max-w-xl">
          * O algoritmo de TDEE adaptativo utiliza regressão linear ponderada.
          Pesagens esparsas (poucos pontos) reduzem a confiança da tendência.
          Outliers acima de 1kg/dia são descartados automaticamente.
        </p>
      </div>

      <!-- Body Composition -->
      <div
        class="bg-light-bg rounded-2xl border border-secondary p-6 flex flex-col justify-center shadow-lg hover:border-primary/50 transition-colors"
      >
        <h3
          class="text-text-secondary text-xs font-bold uppercase tracking-wider mb-4"
        >
          Composição Corporal
        </h3>

        <div *ngIf="stats()?.fat_change_kg" class="space-y-6">
          <!-- Fat -->
          <div>
            <div class="flex justify-between text-xs mb-2">
              <span class="text-text-secondary"
                >Gordura
                {{
                  stats()?.end_fat_pct ? "(" + stats()?.end_fat_pct + "%)" : ""
                }}</span
              >
              <span
                class="font-bold"
                [ngClass]="
                  stats()?.fat_change_kg < 0 ? 'text-green-400' : 'text-red-400'
                "
              >
                <span *ngIf="stats()?.fat_change_kg > 0">↑</span>
                <span *ngIf="stats()?.fat_change_kg < 0">↓</span>
                {{ stats()?.fat_change_kg > 0 ? "+" : ""
                }}{{ stats()?.fat_change_kg }} kg
              </span>
            </div>
            <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
              <div
                class="h-full bg-yellow-500/50 rounded-full transition-all duration-1000"
                [style.width.%]="stats()?.end_fat_pct || 20"
              ></div>
            </div>
          </div>

          <!-- Muscle -->
          <div>
            <div class="flex justify-between text-xs mb-2">
              <span class="text-text-secondary"
                >Massa Muscular
                {{
                  stats()?.end_muscle_pct
                    ? "(" + stats()?.end_muscle_pct + "%)"
                    : ""
                }}</span
              >
              <span
                class="font-bold"
                [ngClass]="
                  stats()?.muscle_change_kg > 0
                    ? 'text-green-400'
                    : 'text-text-secondary'
                "
              >
                <span *ngIf="stats()?.muscle_change_kg > 0">↑</span>
                <span *ngIf="stats()?.muscle_change_kg < 0">↓</span>
                {{ stats()?.muscle_change_kg > 0 ? "+" : ""
                }}{{ stats()?.muscle_change_kg }} kg
              </span>
            </div>
            <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
              <div
                class="h-full bg-primary/40 rounded-full transition-all duration-1000"
                [style.width.%]="stats()?.end_muscle_pct || 40"
              ></div>
            </div>
          </div>
        </div>

        <div
          *ngIf="!stats()?.fat_change_kg"
          class="text-center py-8 opacity-50"
        >
          <span class="text-2xl grayscale">⚖️</span>
          <p class="text-xs mt-2">Sem dados de % Gordura</p>
        </div>
      </div>
    </div>

    <!-- Empty State / Education-->
    <div
      *ngIf="stats()?.confidence === 'none'"
      class="mt-8 p-6 bg-light-bg border border-secondary rounded-xl flex items-start gap-4 shadow-lg"
    >
      <span class="text-2xl">ℹ️</span>
      <div>
        <h3 class="text-white font-bold text-sm mb-1">
          Como funciona a calibração?
        </h3>
        <p class="text-text-secondary text-sm">
          O algoritmo precisa de pelo menos 7 dias de dados de peso e nutrição
          consistentes para calibrar seu metabolismo. Continue registrando
          diariamente para ver sua meta dinâmica!
        </p>
      </div>
    </div>
  </ng-container>
</div>
