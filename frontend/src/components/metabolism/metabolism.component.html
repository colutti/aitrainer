<div class="h-full overflow-y-auto p-8 bg-dark-bg text-text-primary">
    <h1 class="text-3xl font-bold mb-8 tracking-tight">Seu Metabolismo</h1>

    <!-- Loading State -->
    <div *ngIf="isLoading()" class="flex justify-center items-center h-64">
      <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
    </div>

    <ng-container *ngIf="!isLoading()">
        <!-- Date Range Header -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3 bg-light-bg px-4 py-2 rounded-full border border-white/10">
                <span class="text-xs font-bold text-text-secondary uppercase tracking-widest hidden md:inline">Período Analisado</span>
                <span class="text-white font-bold text-sm">
                   {{ stats()?.startDate | date:'dd MMM' }} - {{ stats()?.endDate | date:'dd MMM' }}
                </span>
                <span class="text-xs text-green-400 bg-green-400/10 px-2 py-0.5 rounded-full border border-green-400/20" data-cy="logs-count">
                    {{ stats()?.logs_count }} dias
                </span>
            </div>
            
            <div class="flex items-center gap-2 text-xs text-secondary cursor-pointer hover:text-white transition-colors">
                 <span>⚙️ Configurar Preferências</span>
            </div>
        </div>

        <!-- AI Insight (HERO) - NOW AT TOP -->
        <div class="mb-8" *ngIf="stats()?.confidence !== 'none'">
            <div class="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 rounded-2xl border border-primary/20 p-[1px] shadow-2xl relative overflow-hidden group">
                <!-- Animated shine effect -->
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-primary/10 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000 ease-out pointer-events-none z-10"></div>
                
                <div class="bg-gray-900/95 rounded-2xl p-6 md:p-8 flex flex-col md:flex-row gap-8 relative z-0">
                    <!-- Trainer Avatar & Pulse -->
                    <div class="flex-shrink-0 flex justify-center md:block">
                        <div class="relative w-24 h-24 md:w-32 md:h-32">
                            <div class="absolute inset-0 bg-primary/20 rounded-full blur-xl animate-pulse"></div>
                            <img 
                                [src]="currentTrainer()?.avatar_url || 'assets/trainer-ai.png'" 
                                onerror="this.src='https://api.dicebear.com/7.x/bottts/svg?seed=Atlas'"
                                alt="Trainer" 
                                class="w-full h-full rounded-full border-2 border-primary/50 relative z-10 bg-gray-800 object-cover"
                            >
                            <div class="absolute -bottom-2 -right-2 bg-gray-800 px-3 py-1 rounded-full border border-primary/30 text-[10px] font-bold text-primary uppercase shadow-lg z-20">
                                AI Coach
                            </div>
                        </div>
                    </div>
                    
                    <!-- Insight Text -->
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-4"> 
                            <span class="animate-pulse text-purple-400">●</span>
                            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest" data-cy="trainer-analysis-header">Análise de Hoje</h2>
                        </div>
                        
                        <div *ngIf="isInsightLoading() && !insightText()" class="space-y-3 opacity-50 animate-pulse">
                            <div class="h-4 bg-gray-700 rounded w-3/4"></div>
                            <div class="h-4 bg-gray-700 rounded w-1/2"></div>
                        </div>

                        <markdown 
                            [data]="insightText()" 
                            class="prose prose-invert prose-p:text-gray-200 prose-p:leading-relaxed prose-p:font-light text-base md:text-lg max-w-none prose-strong:font-bold prose-strong:text-purple-300 [&_*]:no-underline">
                        </markdown>
                        
                        <div class="mt-6 flex items-center gap-4 text-xs text-gray-500 font-mono border-t border-white/5 pt-4">
                            <span>Modelo: v3.5-Turbo</span>
                            <span>•</span>
                            <span>Calibrado com {{ stats()?.weight_logs_count }} pontos de dados</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widgets Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- W2: Metrics Summary (Target) -->
             <div class="bg-gray-900 rounded-2xl border border-white/5 p-6 flex flex-col justify-between">
                <h3 class="text-sm font-bold text-white mb-4">Meta Diária</h3>
                
                <div class="flex items-baseline gap-2 mb-2">
                    <span class="text-5xl font-black text-white tracking-tighter" data-cy="daily-target">{{ stats()?.daily_target }}</span>
                    <span class="text-sm text-gray-400">kcal</span>
                </div>
                
                <div class="space-y-3 mt-4">
                    <div class="flex justify-between text-xs py-2 border-b border-white/5">
                        <span class="text-gray-400">TDEE Estimado</span>
                        <span class="font-mono text-white" data-cy="tdee-value">{{ stats()?.tdee }} kcal</span>
                    </div>
                    <div class="flex justify-between text-xs py-2 border-b border-white/5">
                        <span class="text-gray-400">Balanço Atual</span>
                        <span class="font-mono" [ngClass]="stats()?.energy_balance > 0 ? 'text-red-400' : 'text-green-400'">
                            {{ stats()?.energy_balance > 0 ? '+' : '' }}{{ stats()?.energy_balance | number:'1.0-0' }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- W3: TDEE Confidence -->
            <div class="bg-gray-900 rounded-2xl border border-white/5 p-6 flex flex-col justify-between">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-sm font-bold text-white">Confiança do TDEE</h3>
                    <div class="text-gray-600">•••</div>
                </div>

                <div class="flex flex-col items-center justify-center flex-1 py-4">
                    <div class="relative w-40 h-20 overflow-hidden mb-2">
                        <div class="absolute w-40 h-40 rounded-full border-[12px] border-gray-800 border-t-transparent border-l-transparent -rotate-45"
                             style="border-top-color: transparent; border-left-color: transparent;"></div>
                        <div class="absolute w-40 h-40 rounded-full border-[12px] border-transparent border-t-[var(--color-gauge)] border-r-[var(--color-gauge)] -rotate-45 transition-all duration-1000"
                             [style.--color-gauge]="getConfidenceColorHex(stats()?.confidence)"
                             [style.clip-path]="stats()?.confidence === 'high' ? 'inset(0 0 50% 0)' : (stats()?.confidence === 'medium' ? 'inset(0 25% 50% 0)' : 'inset(0 70% 50% 0)')">
                        </div>
                    </div>
                    <span class="text-xl font-bold uppercase tracking-widest" [ngClass]="getConfidenceColor(stats()?.confidence)">
                        {{ stats()?.confidence || 'NONE' }}
                    </span>
                 </div>
                 
                 <div class="bg-black/20 rounded-lg p-3 text-center border border-white/5">
                     <p class="text-[10px] text-gray-400">
                        {{ getConfidenceReason(stats()) }}
                     </p>
                 </div>
            </div>
            <!-- W4: Current Weight & Sparkline -->
            <div class="bg-gray-900 rounded-2xl border border-white/5 p-6 flex flex-col justify-between h-full min-h-[280px]">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-sm font-bold text-white">Peso Atual</h3>
                    <span class="text-[10px] text-gray-500 uppercase tracking-widest">30 dias</span>
                </div>

                <div class="flex items-baseline gap-2 mb-4">
                    <span class="text-4xl font-black text-white tracking-tighter">{{ stats()?.latest_weight }}</span>
                    <span class="text-sm text-gray-400">kg</span>
                </div>

                <!-- Sparkline -->
                <div class="flex-1 min-h-[60px] relative mt-2 flex items-center">
                    <svg viewBox="0 0 100 40" preserveAspectRatio="none" class="w-full h-12 overflow-visible">
                        <path [attr.d]="getSparklinePath()" 
                              fill="none" 
                              stroke="var(--color-primary)" 
                              stroke-width="2" 
                              stroke-linecap="round" 
                              stroke-linejoin="round"
                              class="transition-all duration-1000"/>
                    </svg>
                </div>
                
                <div class="flex justify-between items-center mt-6 pt-4 border-t border-white/5">
                    <div class="text-[10px] text-gray-400 uppercase tracking-tighter font-bold">Variação Total</div>
                    <div class="text-xs font-bold" [ngClass]="(stats()?.end_weight - stats()?.start_weight) < 0 ? 'text-green-400' : 'text-red-400'">
                        {{ (stats()?.end_weight - stats()?.start_weight) > 0 ? '+' : '' }}{{ (stats()?.end_weight - stats()?.start_weight) | number:'1.1-1' }} kg
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 3: Transparency & Body Comp -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
             <!-- Transparency Chart Content -->
             <div class="lg:col-span-2 bg-gray-900 rounded-2xl border border-white/5 p-6 relative overflow-hidden">
                 <h3 class="text-sm font-bold text-white mb-6" data-cy="transparency-title">Transparência dos Dados</h3>
                 
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                     <!-- Weight Points -->
                     <div class="bg-black/20 rounded-xl p-3 border border-white/5">
                         <div class="text-2xl font-bold text-blue-400 mb-1">{{ stats()?.weight_logs_count }}</div>
                         <div class="text-[10px] text-gray-400 uppercase font-bold">Pesagens</div>
                     </div>
                     <!-- Nutrition Days -->
                     <div class="bg-black/20 rounded-xl p-3 border border-white/5">
                         <div class="text-2xl font-bold text-green-400 mb-1">{{ stats()?.nutrition_logs_count }}</div>
                         <div class="text-[10px] text-gray-400 uppercase font-bold">Dias de Dieta</div>
                     </div>
                     <!-- Outliers -->
                     <div class="bg-black/20 rounded-xl p-3 border border-red-500/10 hover:border-red-500/30 transition-colors">
                         <div class="text-2xl font-bold text-red-400 mb-1">{{ stats()?.outliers_count || 0 }}</div>
                         <div class="text-[10px] text-gray-400 uppercase font-bold">Outliers Ignorados</div>
                     </div>
                      <!-- Date Range -->
                      <div class="bg-black/20 rounded-xl p-3 border border-white/5">
                        <div class="text-xs font-bold text-white mb-1">{{ stats()?.logs_count }} dias</div>
                        <div class="text-[10px] text-gray-400 uppercase font-bold">Janela Total</div>
                    </div>
                 </div>

                  <!-- Heatmap -->
                  <div class="mb-6">
                      <div class="flex justify-between items-center mb-3">
                          <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Consistência (Últimos 28 dias)</h4>
                          <div class="flex gap-2 items-center">
                              <div class="flex items-center gap-1">
                                  <div class="w-2 h-2 rounded-sm bg-blue-500/50"></div>
                                  <span class="text-[8px] text-gray-500">Peso</span>
                              </div>
                              <div class="flex items-center gap-1">
                                  <div class="w-2 h-2 rounded-sm bg-green-500/50"></div>
                                  <span class="text-[8px] text-gray-500">Dieta</span>
                              </div>
                              <div class="flex items-center gap-1">
                                  <div class="w-2 h-2 rounded-sm bg-cyan-400"></div>
                                  <span class="text-[8px] text-gray-500">Ambos</span>
                              </div>
                          </div>
                      </div>
                      <div class="flex flex-wrap gap-1.5">
                          <div *ngFor="let day of stats()?.consistency" 
                               class="w-4 h-4 rounded-sm transition-all duration-300 hover:scale-110 cursor-help relative group"
                               [ngClass]="{
                                 'bg-gray-800': !day.weight && !day.nutrition,
                                 'bg-blue-500/40': day.weight && !day.nutrition,
                                 'bg-green-500/40': !day.weight && day.nutrition,
                                 'bg-cyan-400 shadow-[0_0_8px_rgba(34,211,238,0.4)]': day.weight && day.nutrition
                               }"
                               [title]="day.date">
                               <!-- Tooltip logic if needed -->
                          </div>
                      </div>
                  </div>

                 <p class="text-[10px] text-gray-500 max-w-xl">
                    * O algoritmo de TDEE adaptativo utiliza regressão linear ponderada. Pesagens esparsas (poucos pontos) reduzem a confiança da tendência. Outliers acima de 1kg/dia são descartados automaticamente.
                 </p>
             </div>

             <!-- Body Composition -->
             <div class="bg-gray-900 rounded-2xl border border-white/5 p-6 flex flex-col justify-center">
                 <h3 class="text-sm font-bold text-white mb-4">Composição Corporal</h3>
                 
                 <div *ngIf="stats()?.fat_change_kg" class="space-y-6">
                     <!-- Fat -->
                     <div>
                         <div class="flex justify-between text-xs mb-2">
                             <span class="text-gray-400">Gordura {{ stats()?.end_fat_pct ? '(' + stats()?.end_fat_pct + '%)' : '' }}</span>
                             <span class="font-bold" [ngClass]="stats()?.fat_change_kg < 0 ? 'text-green-400' : 'text-red-400'">
                                 <span *ngIf="stats()?.fat_change_kg > 0">↑</span>
                                 <span *ngIf="stats()?.fat_change_kg < 0">↓</span>
                                 {{ stats()?.fat_change_kg > 0 ? '+' : ''}}{{ stats()?.fat_change_kg }} kg
                             </span>
                         </div>
                         <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
                             <div class="h-full bg-yellow-500/50 rounded-full transition-all duration-1000" [style.width.%]="stats()?.end_fat_pct || 20"></div>
                         </div>
                     </div>

                     <!-- Muscle -->
                     <div>
                        <div class="flex justify-between text-xs mb-2">
                            <span class="text-gray-400">Massa Muscular {{ stats()?.end_muscle_pct ? '(' + stats()?.end_muscle_pct + '%)' : '' }}</span>
                            <span class="font-bold" [ngClass]="(stats()?.muscle_change_kg ?? stats()?.lean_change_kg) > 0 ? 'text-green-400' : 'text-gray-400'">
                                <span *ngIf="(stats()?.muscle_change_kg ?? stats()?.lean_change_kg) > 0">↑</span>
                                <span *ngIf="(stats()?.muscle_change_kg ?? stats()?.lean_change_kg) < 0">↓</span>
                                {{ (stats()?.muscle_change_kg ?? stats()?.lean_change_kg) > 0 ? '+' : ''}}{{ stats()?.muscle_change_kg ?? stats()?.lean_change_kg }} kg
                            </span>
                        </div>
                        <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
                            <div class="h-full bg-purple-500/50 rounded-full transition-all duration-1000" [style.width.%]="stats()?.end_muscle_pct || 40"></div>
                        </div>
                    </div>
                 </div>

                 <div *ngIf="!stats()?.fat_change_kg" class="text-center py-8 opacity-50">
                     <span class="text-2xl grayscale">⚖️</span>
                     <p class="text-xs mt-2">Sem dados de % Gordura</p>
                 </div>
             </div>
        </div>

        <!-- Empty State / Education-->
        <div *ngIf="stats()?.confidence === 'none'" class="mt-8 p-6 bg-blue-900/20 border border-blue-500/30 rounded-xl flex items-start gap-4">
           <span class="text-2xl">ℹ️</span>
           <div>
               <h3 class="text-blue-100 font-bold text-sm mb-1">Como funciona a calibração?</h3>
               <p class="text-blue-200/70 text-sm">
                   O algoritmo precisa de pelo menos 7 dias de dados de peso e nutrição consistentes para calibrar seu metabolismo. Continue registrando diariamente para ver sua meta dinâmica!
               </p>
           </div>
       </div>

    </ng-container>
</div>
