<div
  class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"
  (click)="closeModal()"
>
  <div
    class="w-full max-w-md rounded-2xl border border-white/10 bg-[#1a1a1a] shadow-2xl relative"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="flex items-center justify-between p-6 border-b border-white/10">
      <div class="flex items-center gap-3">
        <div
          class="flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-500/20 text-xl"
        >
          üèãÔ∏è
        </div>
        <div>
          <h2 class="text-lg font-bold text-white">Hevy</h2>
          <p class="text-xs text-gray-400">Sincroniza√ß√£o de treinos</p>
        </div>
      </div>
      <button (click)="closeModal()" class="text-gray-400 hover:text-white p-1">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>

    <!-- Content -->
    <div class="p-6">
      <!-- Loading State -->
      <div
        *ngIf="viewState() === 'loading'"
        class="flex flex-col items-center justify-center py-8 gap-4"
      >
        <div
          class="animate-spin h-10 w-10 border-4 border-emerald-500 border-t-transparent rounded-full"
        ></div>
        <p class="text-sm text-gray-400">Processando...</p>
      </div>

      <!-- Setup State (No API Key) -->
      <div *ngIf="viewState() === 'setup'" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2"
            >Chave de API do Hevy</label
          >
          <input
            type="text"
            [(ngModel)]="apiKeyInput"
            placeholder="Cole sua chave aqui..."
            class="w-full rounded-lg bg-black/40 border border-white/10 px-4 py-3 text-white placeholder-gray-500 focus:border-emerald-500 focus:outline-none"
          />
        </div>
        <p *ngIf="errorMessage()" class="text-sm text-red-400 font-medium">
          {{ errorMessage() }}
        </p>
        <button
          (click)="validateAndConnect()"
          [disabled]="validating() || !apiKeyInput.trim()"
          class="w-full rounded-lg bg-emerald-600 px-4 py-3 font-semibold text-white hover:bg-emerald-500 disabled:opacity-50 transition-colors"
        >
          {{ validating() ? "Validando..." : "Conectar" }}
        </button>
      </div>

      <!-- Connected State -->
      <div *ngIf="viewState() === 'connected'" class="space-y-6">
        <div class="p-4 rounded-xl bg-white/5 border border-white/5">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <div
                class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"
              ></div>
              <p class="text-sm font-bold text-white">Conectado</p>
            </div>
            <button
              (click)="startDisconnect()"
              class="text-xs text-red-400 hover:underline"
            >
              Desconectar
            </button>
          </div>
          <p
            class="text-[10px] text-gray-500 uppercase tracking-widest font-bold text-center"
          >
            Sua Chave
          </p>
          <p class="text-center text-lg font-mono text-gray-300 mb-2">
            {{ maskedKey() }}
          </p>
        </div>

        <div class="space-y-4">
          <h3 class="text-sm font-semibold text-white">Sincronizar Treinos</h3>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label
                class="text-[9px] text-gray-500 font-bold uppercase mb-1 block"
                >Desde (DD/MM/AAAA)</label
              >
              <input
                type="text"
                [(ngModel)]="importDateDisplay"
                placeholder="01/01/2025"
                class="w-full rounded-lg bg-black/40 border border-white/10 px-3 py-2 text-white text-sm"
              />
            </div>
            <div>
              <label
                class="text-[9px] text-gray-500 font-bold uppercase mb-1 block"
                >Duplicatas</label
              >
              <select
                [(ngModel)]="importMode"
                class="w-full rounded-lg bg-black/40 border border-white/10 px-3 py-2 text-white text-sm"
              >
                <option value="skip_duplicates">Pular</option>
                <option value="overwrite">Sobrescrever</option>
              </select>
            </div>
          </div>
          <button
            (click)="runImport()"
            [disabled]="importing()"
            class="w-full rounded-lg bg-gradient-to-r from-emerald-600 to-emerald-700 px-4 py-3 font-bold text-sm text-white shadow-lg shadow-emerald-900/20"
          >
            {{ importing() ? "Sincronizando..." : "Importar Treinos do Hevy" }}
          </button>

          <div
            class="flex justify-between text-[10px] text-gray-500 uppercase font-bold tracking-widest"
          >
            <span *ngIf="workoutCount() > 0"
              >{{ workoutCount() }} treinos no Hevy</span
            >
            <span *ngIf="lastSync()">Sync: {{ lastSync() | date:'dd MMM, HH:mm' }}</span>
          </div>
        </div>

        <!-- Feedback Messages -->
        <div
          *ngIf="successMessage()"
          class="p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-sm font-medium text-center"
        >
          {{ successMessage() }}
        </div>
        <div
          *ngIf="errorMessage()"
          class="p-4 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400 text-sm font-medium text-center"
        >
          {{ errorMessage() }}
        </div>

        <!-- Detailed Import Results -->
        <div
          *ngIf="importResult()"
          class="p-4 rounded-xl bg-white/5 border border-white/5 space-y-3"
        >
          <p
            class="text-[10px] font-bold text-gray-500 uppercase tracking-widest text-center"
          >
            Resultado do Processamento
          </p>
          <div class="grid grid-cols-3 gap-2 text-center">
            <div class="p-3 rounded-lg bg-emerald-500/5">
              <p class="text-emerald-400 text-lg font-bold">
                {{ importResult()?.imported }}
              </p>
              <p class="text-[9px] text-gray-500 uppercase font-bold">Novos</p>
            </div>
            <div class="p-3 rounded-lg bg-yellow-500/5">
              <p class="text-yellow-400 text-lg font-bold">
                {{ importResult()?.skipped }}
              </p>
              <p class="text-[9px] text-gray-500 uppercase font-bold">
                Pulados
              </p>
            </div>
            <div class="p-3 rounded-lg bg-red-500/5">
              <p class="text-red-400 text-lg font-bold">
                {{ importResult()?.failed }}
              </p>
              <p class="text-[9px] text-gray-500 uppercase font-bold">Falhas</p>
            </div>
          </div>
        </div>

        <!-- Webhook Section -->
        <div class="mt-6 p-4 rounded-xl bg-emerald-500/5 border border-white/10 space-y-4">
          <div class="flex items-center gap-2">
            <span class="text-lg">üîó</span>
            <h3 class="text-sm font-bold text-white">Sincroniza√ß√£o Autom√°tica</h3>
          </div>
          
          <p class="text-xs text-gray-400">
            Configure o webhook no app Hevy para sincronizar treinos automaticamente.
          </p>

          <div *ngIf="webhookUrl()" class="space-y-4">
            <!-- URL -->
            <div>
              <label class="text-[9px] text-gray-500 font-bold uppercase mb-1 block">
                URL do Webhook
              </label>
              <div class="flex items-center gap-2">
                <input 
                  type="text" 
                  readonly 
                  [value]="webhookUrl()" 
                  class="flex-1 rounded-lg bg-black/40 border border-white/10 px-3 py-2 text-gray-300 text-[10px] font-mono truncate"
                />
                <button 
                  (click)="copyToClipboard(webhookUrl()!, 'URL')" 
                  class="px-2 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20 text-sm"
                  title="Copiar URL"
                >üìã</button>
              </div>
            </div>
            
            <!-- Authorization Header -->
            <div>
              <label class="text-[9px] text-gray-500 font-bold uppercase mb-1 block">
                Authorization Header
              </label>
              <div class="flex items-center gap-2">
                <input 
                  type="text" 
                  readonly 
                  [value]="webhookAuthHeader()" 
                  class="flex-1 rounded-lg bg-black/40 border border-white/10 px-3 py-2 text-gray-300 text-[10px] font-mono"
                />
                <button 
                  (click)="copyToClipboard(webhookAuthHeader()!, 'Header')" 
                  class="px-2 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20 text-sm"
                  title="Copiar Header"
                >üìã</button>
              </div>
            </div>

            <!-- Warning if just generated -->
            <div *ngIf="showFullAuth()" class="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
              <p class="text-xs text-yellow-300 font-medium">
                ‚ö†Ô∏è Copie o Authorization Header agora! Ele n√£o ser√° mostrado novamente por seguran√ßa.
              </p>
            </div>
            
            <!-- Instructions -->
            <div class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20 space-y-2">
              <p class="text-xs text-emerald-300 font-bold">üì± No app Hevy:</p>
              <ol class="text-xs text-emerald-200 space-y-1 list-decimal list-inside">
                <li>Settings ‚Üí Webhooks</li>
                <li>Cole a <strong>URL</strong> no campo "URL"</li>
                <li>Cole o <strong>Authorization Header</strong></li>
                <li>Salve</li>
              </ol>
            </div>

            <button 
              (click)="revokeWebhook()"
              class="w-full text-[10px] text-red-400 hover:underline uppercase font-bold tracking-widest text-center"
            >
              Revogar Webhook
            </button>
          </div>

          <div *ngIf="!webhookUrl()">
            <button 
              (click)="generateWebhook()"
              [disabled]="generatingWebhook()"
              class="w-full rounded-lg bg-emerald-600 px-4 py-3 font-bold text-sm text-white hover:bg-emerald-500 disabled:opacity-50 shadow-lg"
            >
              {{ generatingWebhook() ? 'Gerando...' : '‚ö° Ativar Sincroniza√ß√£o Autom√°tica' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Confirm Disconnect State -->
      <div *ngIf="viewState() === 'confirm_disconnect'" class="py-4 space-y-6">
        <div
          class="p-6 bg-red-500/5 border border-red-500/10 rounded-2xl text-center space-y-4"
        >
          <div
            class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-500/20 text-red-500 text-2xl"
          >
            ‚ö†Ô∏è
          </div>
          <div>
            <h3 class="text-lg font-bold text-white">Desconectar Hevy?</h3>
            <p class="text-sm text-gray-400 mt-1">
              Sua chave de API ser√° removida e a sincroniza√ß√£o autom√°tica ser√°
              desativada.
            </p>
          </div>
          <div class="flex flex-col gap-2">
            <button
              (click)="confirmDisconnect()"
              class="w-full rounded-xl bg-red-600 px-4 py-3 font-bold text-white hover:bg-red-500 transition-colors"
            >
              Sim, desconectar
            </button>
            <button
              (click)="cancelDisconnect()"
              class="w-full rounded-xl bg-white/5 px-4 py-3 font-bold text-white hover:bg-white/10 transition-colors"
            >
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
