<div
  class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"
  (click)="closeModal()"
>
  <div
    class="w-full max-w-md rounded-2xl border border-white/10 bg-[#1a1a1a] shadow-2xl relative max-h-[90vh] overflow-y-auto"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="flex items-center justify-between p-6 border-b border-white/10 sticky top-0 bg-[#1a1a1a] z-10">
      <div class="flex items-center gap-3">
        <div
          class="flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-500/20 text-xl"
        >
          üçé
        </div>
        <div>
          <h2 class="text-lg font-bold text-white">MyFitnessPal</h2>
          <!-- <p class="text-xs text-gray-400">Importar hist√≥rico</p> -->
        </div>
      </div>
      <button (click)="closeModal()" class="text-gray-400 hover:text-white p-1">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>

    <!-- Content -->
    <div class="p-6 space-y-6">
      
      <!-- Instructions Toggle -->
      <div *ngIf="viewState() === 'setup'" class="space-y-4">
        <div 
          class="p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20 cursor-pointer hover:bg-emerald-500/20 transition-colors"
          (click)="toggleInstructions()"
        >
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-bold text-emerald-300">üìÖ Como exportar seus dados</h3>
            <span class="text-emerald-300 transform transition-transform" [class.rotate-180]="showInstructions()">‚ñº</span>
          </div>
          
          <div *ngIf="showInstructions()" class="mt-4 space-y-4 text-xs text-emerald-200">
            <div>
              <p class="font-bold mb-1">üåê Via Website:</p>
              <ol class="list-decimal list-inside space-y-1 opacity-80">
                <li>Fa√ßa login em <strong>myfitnesspal.com</strong></li>
                <li>V√° em <strong>Relat√≥rios</strong> (Reports) -> <strong>Exportar</strong> (Export)</li>
                <li>Selecione o intervalo de datas</li>
                <li>Verifique seu email e baixe o arquivo .zip</li>
              </ol>
            </div>
            <div>
              <p class="font-bold mb-1">üì± Via App (iOS/Android):</p>
              <ol class="list-decimal list-inside space-y-1 opacity-80">
                <li>V√° no menu <strong>Mais</strong> -> <strong>Nutri√ß√£o</strong></li>
                <li>Toque no √≠cone de <strong>Exportar</strong> (topo direito)</li>
                <li>Selecione as datas e confirme</li>
              </ol>
            </div>
            <div class="p-2 bg-emerald-500/20 rounded border border-emerald-500/20">
              <p class="font-bold mb-1">üí° Dica:</p>
              <p class="opacity-80">
                Dentro do zip, use o arquivo que come√ßa com: <br/>
                <code class="bg-black/30 px-1 rounded">Resumo-da-alimenta√ß√£o-....csv</code> ou <br/>
                <code class="bg-black/30 px-1 rounded">Nutrition-Summary-....csv</code>
              </p>
            </div>
          </div>
        </div>

        <!-- Warning -->
        <div class="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
          <p class="text-xs text-yellow-300 font-medium">
            ‚ö†Ô∏è Importar dados existentes ir√° <strong>atualizar</strong> os registros desses dias.
          </p>
        </div>

        <!-- File Input -->
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-300">Selecione o arquivo CSV</label>
          <input
            type="file"
            accept=".csv"
            (change)="onFileSelected($event)"
            class="block w-full text-sm text-gray-400
              file:mr-4 file:py-2 file:px-4
              file:rounded-lg file:border-0
              file:text-sm file:font-semibold
              file:bg-emerald-600 file:text-white
              hover:file:bg-emerald-500
              cursor-pointer"
          />
          <p *ngIf="selectedFile()" class="text-xs text-emerald-400 mt-1">
            Arquivo selecionado: {{ selectedFile()?.name }}
          </p>
        </div>

        <!-- Error Message -->
        <p *ngIf="errorMessage()" class="text-sm text-red-400 font-medium text-center">
          {{ errorMessage() }}
        </p>

        <!-- Import Button -->
        <button
          (click)="uploadFile()"
          [disabled]="!selectedFile()"
          class="w-full rounded-lg bg-emerald-600 px-4 py-3 font-semibold text-white hover:bg-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-lg shadow-emerald-900/20"
        >
          Importar Dados
        </button>
      </div>

      <!-- Importing State -->
      <div *ngIf="viewState() === 'importing'" class="flex flex-col items-center justify-center py-8 gap-4">
        <div class="animate-spin h-10 w-10 border-4 border-emerald-500 border-t-transparent rounded-full"></div>
        <p class="text-sm text-gray-400">Processando arquivo...</p>
      </div>

      <!-- Success State -->
      <div *ngIf="viewState() === 'success'" class="space-y-6">
        <div class="flex flex-col items-center gap-2 text-center">
          <div class="flex h-12 w-12 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-500 text-2xl mb-2">
            ‚úì
          </div>
          <h3 class="text-lg font-bold text-white">Importa√ß√£o Conclu√≠da!</h3>
          <p class="text-gray-400 text-sm">Seus dados nutricionais foram atualizados.</p>
        </div>

        <!-- Result Grid -->
         <div *ngIf="importResult()" class="grid grid-cols-3 gap-2 text-center">
            <div class="p-3 rounded-lg bg-emerald-500/5 border border-emerald-500/10">
              <p class="text-emerald-400 text-lg font-bold">{{ importResult()?.created }}</p>
              <p class="text-[9px] text-gray-500 uppercase font-bold">Novos</p>
            </div>
            <div class="p-3 rounded-lg bg-yellow-500/5 border border-yellow-500/10">
              <p class="text-yellow-400 text-lg font-bold">{{ importResult()?.updated }}</p>
              <p class="text-[9px] text-gray-500 uppercase font-bold">Atualizados</p>
            </div>
            <div class="p-3 rounded-lg bg-red-500/5 border border-red-500/10">
              <p class="text-red-400 text-lg font-bold">{{ importResult()?.errors }}</p>
              <p class="text-[9px] text-gray-500 uppercase font-bold">Erros</p>
            </div>
          </div>
        
        <div class="bg-white/5 rounded-lg p-3 text-center">
           <p class="text-xs text-gray-400">Total de dias processados: <span class="text-white font-bold">{{ importResult()?.total_days }}</span></p>
        </div>

        <button
          (click)="closeModal()"
          class="w-full rounded-lg bg-white/10 px-4 py-3 font-semibold text-white hover:bg-white/20 transition-colors"
        >
          Fechar
        </button>

        <button
          (click)="reset()"
          class="w-full text-xs text-gray-500 hover:text-white"
        >
          Importar outro arquivo
        </button>
      </div>

    </div>
  </div>
</div>
